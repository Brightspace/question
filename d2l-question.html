<link rel="import" href="../promise-polyfill/promise-polyfill.html">
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../d2l-fetch-siren-entity-behavior/d2l-fetch-siren-entity-behavior.html">
<link rel="import" href="../d2l-fetch-auth/d2l-fetch-auth.html">
<link rel="import" href="../d2l-fetch-auth/d2l-fetch-auth-framed.html">
<link rel="import" href="./quiz/d2l-quiz-question-multiple-choice.html">
<link rel="import" href="./quiz/d2l-quiz-question-short-answer.html">
<link rel="import" href="./quiz/d2l-quiz-question-multi-select.html">
<link rel="import" href="./quiz/d2l-quiz-question-written-response.html">
<link rel="import" href="./quiz/d2l-quiz-question-not-supported.html">

<!--
'd2l-question'
Polymer-based web component for D2L questions

@demo demo/index.hmtl
-->

<dom-module id="d2l-question">
  <template>
    <style>
      :host {
        display: block;
        --d2l-quiz-question-written-response-max-width-in-px: var(--d2l-question-max-width, 500px);
        --d2l-quiz-question-short-answer-max-width-in-px: var(--d2l-question-max-width, 500px);
      }
    </style>
  </template>

  <script>
		const QuestionTypeEnum = {
			MULTIPLE_CHOICE: {value: 1, string: 'Multiple Choice'},
			TRUE_FALSE :  {value: 2, string: 'True or False'},
			FILL_IN_BLANKS :  {value: 3, string: 'Fill in the Blanks'},
			MULTI_SELECT :  {value: 4, string: 'Multi-Select'},
			MATCHING :  {value: 5, string: 'Matching'},
			ORDERING :  {value: 6, string: 'Ordering'},
			WRITTEN_RESPONSE :  {value: 7, string: 'Written Response'},
			SHORT_ANSWER :  {value: 8, string: 'Short Answer'},
			LIKERT :  {value: 9, string: 'Likert'},
			IMAGE_INFORMATION :  {value: 10, string: 'Image Information'},
			TEXT_INFORMATION :  {value: 11, string: 'Text Information'},
			ARITHMETIC :  {value: 12, string: 'Arithmetic'},
			SIGNIFICANT_FIGURES :  {value: 13, string: 'Significant Figures'},
			MULTI_SHORT_ANSWER : {value: 14, string: 'Multi-Short Answer'}
		};

		class D2LQuestion extends Polymer.mixinBehaviors(D2L.PolymerBehaviors.FetchSirenEntityBehavior, Polymer.Element) {
			static get is() {
				return 'd2l-question';
			}

			constructor() {
				super();
				window.d2lfetch.use({name: 'auth', fn: window.d2lfetch.auth});
			}

			static get properties() {
				return {
					href: {
						type: String,
						observer: '_getQuestionData'
					}
				};
			}

			_appendQuestionType(questionData) {
				try {
					const question = {};
					const config = {};

					const childNodes = this.shadowRoot.childNodes;
					if (childNodes) {
						for (let i = 0; i < childNodes.length; i++) {
							if (childNodes[i].nodeName === 'D2L-QUIZ-QUESTION-MULTIPLE-CHOICE' ||
								childNodes[i].nodeName === 'D2L-QUIZ-QUESTION-SHORT-ANSWER' ||
								childNodes[i].nodeName === 'D2L-QUIZ-QUESTION-MULTI-SELECT' ||
								childNodes[i].nodeName === 'D2L-QUIZ-QUESTION-WRITTEN-RESPONSE' ||
								childNodes[i].nodeName === 'D2L-QUIZ-QUESTION-NOT-SUPPORTED' ) {
								this.shadowRoot.removeChild(childNodes[i]);
							}
						}
					}

					switch (questionData.properties.question.extension.questionType) {
						case QuestionTypeEnum.TRUE_FALSE.value:
							question.bodyText = questionData.properties.question.choiceInteraction.prompt;
							question.choices = [{text: 'True'}, {text: 'False'}];

							if (questionData.properties.question.modalFeedback.hint.text) {
								question.hint = questionData.properties.question.modalFeedback.hint.text;
							}

							if (questionData.properties.question.choiceInteraction.enumeration) {
								question.enumeration = questionData.properties.question.choiceInteraction.enumeration;
							}

							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-multiple-choice'));
							this.shadowRoot.querySelector('d2l-quiz-question-multiple-choice').setAttribute('question-data', JSON.stringify(question));
							break;

						case QuestionTypeEnum.MULTIPLE_CHOICE.value: {
							question.bodyText = questionData.properties.question.choiceInteraction.prompt;

							const choices = [];
							for (const prop in questionData.properties.question.choiceInteraction.choices) {
								if (questionData.properties.question.choiceInteraction.choices.hasOwnProperty(prop)) {
									const choice = {};
									choice.text = questionData.properties.question.choiceInteraction.choices[prop].text;
									choices.push(choice);
								}
							}
							question.choices = choices;

							question.randomization = questionData.properties.question.choiceInteraction.shuffle;

							if (questionData.properties.question.modalFeedback.hint.text) {
								question.hint = questionData.properties.question.modalFeedback.hint.text;
							}

							if (questionData.properties.question.choiceInteraction.enumeration) {
								question.enumeration = questionData.properties.question.choiceInteraction.enumeration;
							}

							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-multiple-choice'));
							this.shadowRoot.querySelector('d2l-quiz-question-multiple-choice').setAttribute('question-data', JSON.stringify(question));
							break;
						}

						case QuestionTypeEnum.SHORT_ANSWER.value: {
							question.bodyText = questionData.properties.question.interaction.prompt;

							if (questionData.properties.question.modalFeedback.hint.text) {
								question.hint = questionData.properties.question.modalFeedback.hint.text;
							}

							const answers = [];
							for (const prop in questionData.properties.question.response.responseItems) {
								if (questionData.properties.question.response.responseItems.hasOwnProperty(prop)) {
									const answer = {};
									answer.rows = questionData.properties.question.response.responseItems[prop].legacyRows;
									answer.cols = questionData.properties.question.response.responseItems[prop].legacyCols;
									answers.push(answer);
								}
							}
							question.answers = answers;

							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-short-answer'));
							this.shadowRoot.querySelector('d2l-quiz-question-short-answer').setAttribute('question-data', JSON.stringify(question));
							break;
						}

						case QuestionTypeEnum.MULTI_SELECT.value: {
							question.bodyText = questionData.properties.question.choiceInteraction.prompt;

							const choices = [];
							for (const prop in questionData.properties.question.choiceInteraction.choices) {
								if (questionData.properties.question.choiceInteraction.choices.hasOwnProperty(prop)) {
									const choice = {};
									choice.text = questionData.properties.question.choiceInteraction.choices[prop].text;
									choices.push(choice);
								}
							}
							question.choices = choices;

							question.randomization = questionData.properties.question.choiceInteraction.shuffle;

							if (questionData.properties.question.modalFeedback.hint.text) {
								question.hint = questionData.properties.question.modalFeedback.hint.text;
							}

							if (questionData.properties.question.choiceInteraction.enumeration) {
								question.enumeration = questionData.properties.question.choiceInteraction.enumeration;
							}

							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-multi-select'));
							this.shadowRoot.querySelector('d2l-quiz-question-multi-select').setAttribute('question-data', JSON.stringify(question));
							break;
						}

						case QuestionTypeEnum.WRITTEN_RESPONSE.value: {
							question.bodyText = questionData.properties.question.extendedTextInteraction.prompt;

							if (questionData.properties.question.modalFeedback.hint.text) {
								question.hint = questionData.properties.question.modalFeedback.hint.text;
							}

							question.answer = '';

							config.htmlEditorUrl = questionData.properties.htmlEditorPreview.href;
							config.rows = questionData.properties.htmlEditorPreview.legacyRows;
							config.cols = questionData.properties.htmlEditorPreview.legacyCols;

							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-written-response'));
							this.shadowRoot.querySelector('d2l-quiz-question-written-response').setAttribute('question-data', JSON.stringify(question));
							this.shadowRoot.querySelector('d2l-quiz-question-written-response').setAttribute('config-data', JSON.stringify(config));
							break;
						}

						case QuestionTypeEnum.FILL_IN_BLANKS.value:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							this.shadowRoot.querySelector('d2l-quiz-question-not-supported').setAttribute('question-type', QuestionTypeEnum.FILL_IN_BLANKS.string);
							break;

						case QuestionTypeEnum.MATCHING.value:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							this.shadowRoot.querySelector('d2l-quiz-question-not-supported').setAttribute('question-type', QuestionTypeEnum.MATCHING.string);
							break;

						case QuestionTypeEnum.ORDERING.value:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							this.shadowRoot.querySelector('d2l-quiz-question-not-supported').setAttribute('question-type', QuestionTypeEnum.ORDERING.string);
							break;

						case QuestionTypeEnum.LIKERT.value:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							this.shadowRoot.querySelector('d2l-quiz-question-not-supported').setAttribute('question-type', QuestionTypeEnum.LIKERT.string);
							break;

						case QuestionTypeEnum.IMAGE_INFORMATION.value:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							this.shadowRoot.querySelector('d2l-quiz-question-not-supported').setAttribute('question-type', QuestionTypeEnum.IMAGE_INFORMATION.string);
							break;

						case QuestionTypeEnum.TEXT_INFORMATION.value:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							this.shadowRoot.querySelector('d2l-quiz-question-not-supported').setAttribute('question-type', QuestionTypeEnum.TEXT_INFORMATION.string);
							break;

						case QuestionTypeEnum.ARITHMETIC.value:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							this.shadowRoot.querySelector('d2l-quiz-question-not-supported').setAttribute('question-type', QuestionTypeEnum.ARITHMETIC.string);
							break;

						case QuestionTypeEnum.SIGNIFICANT_FIGURES.value:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							this.shadowRoot.querySelector('d2l-quiz-question-not-supported').setAttribute('question-type', QuestionTypeEnum.SIGNIFICANT_FIGURES.string);
							break;

						case QuestionTypeEnum.MULTI_SHORT_ANSWER.value:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							this.shadowRoot.querySelector('d2l-quiz-question-not-supported').setAttribute('question-type', QuestionTypeEnum.MULTI_SHORT_ANSWER.string);
							break;

						default:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							break;
					}
				}
				catch (error) {
					this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
				}
			}

			_getQuestionData() {
				if (this.href) {
					this._fetchEntity(this.href)
						.then((questionData) => {this._appendQuestionType(questionData);}, () => {this._appendQuestionType();});
				}
			}
		}

		customElements.define(D2LQuestion.is, D2LQuestion);
	</script>
</dom-module>
