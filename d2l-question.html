<link rel="import" href="../promise-polyfill/promise-polyfill.html">
<script src="../fetch/fetch.js"></script>
<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../d2l-fetch-siren-entity-behavior/d2l-fetch-siren-entity-behavior.html">
<link rel="import" href="../d2l-fetch-auth/d2l-fetch-auth.html">
<link rel="import" href="../d2l-fetch-auth/d2l-fetch-auth-framed.html">
<link rel="import" href="./quiz/d2l-quiz-question-multiple-choice.html">
<link rel="import" href="./quiz/d2l-quiz-question-short-answer.html">
<link rel="import" href="./quiz/d2l-quiz-question-not-supported.html">

<!--
'd2l-question'
Polymer-based web component for D2L questions

@demo demo/index.hmtl
-->

<dom-module id="d2l-question">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>

  <script>
		const QuestionTypeEnum = {
			MULTIPLE_CHOICE: 1,
			TRUE_FALSE : 2,
			SHORT_ANSWER : 8
		};

		class D2LQuestion extends Polymer.mixinBehaviors(D2L.PolymerBehaviors.FetchSirenEntityBehavior, Polymer.Element) {
			static get is() {
				return 'd2l-question';
			}

			constructor() {
				super();
				window.d2lfetch.use({name: 'auth', fn: window.d2lfetch.auth});
			}

			static get properties() {
				return {
					href: {
						type: String,
						observer: '_getQuestionData'
					}
				};
			}

			_appendQuestionType(questionData) {
				try {
					var question = {};

					var childNodes = this.shadowRoot.childNodes;
					if (childNodes) {
						for (var i = 0; i < childNodes.length; i++) {
							if (childNodes[i].nodeName === 'D2L-QUIZ-QUESTION-MULTIPLE-CHOICE' ||
								childNodes[i].nodeName === 'D2L-QUIZ-QUESTION-SHORT-ANSWER' ||
								childNodes[i].nodeName === 'D2L-QUIZ-QUESTION-NOT-SUPPORTED' ) {
								this.shadowRoot.removeChild(childNodes[i]);
							}
						}
					}

					switch (questionData.properties.question.extension.questionType) {
						case QuestionTypeEnum.TRUE_FALSE:
							question.bodyText = questionData.properties.question.choiceInteraction.prompt;
							question.choices = [{text: 'True'}, {text: 'False'}];

							if (questionData.properties.question.modalFeedback.hint.text) {
								question.hint = questionData.properties.question.modalFeedback.hint.text;
							}

							if (questionData.properties.question.choiceInteraction.enumeration) {
								question.enumeration = questionData.properties.question.choiceInteraction.enumeration;
							}

							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-multiple-choice'));
							this.shadowRoot.querySelector('d2l-quiz-question-multiple-choice').setAttribute('question-data', JSON.stringify(question));
							break;

						case QuestionTypeEnum.MULTIPLE_CHOICE:
							question.bodyText = questionData.properties.question.choiceInteraction.prompt;

							var choices = [];
							for (const prop in questionData.properties.question.choiceInteraction.choices) {
								if (questionData.properties.question.choiceInteraction.choices.hasOwnProperty(prop)) {
									var choice = {};
									choice.text = questionData.properties.question.choiceInteraction.choices[prop].text;
									choices.push(choice);
								}
							}
							question.choices = choices;

							question.randomization = questionData.properties.question.choiceInteraction.shuffle;

							if (questionData.properties.question.modalFeedback.hint.text) {
								question.hint = questionData.properties.question.modalFeedback.hint.text;
							}

							if (questionData.properties.question.choiceInteraction.enumeration) {
								question.enumeration = questionData.properties.question.choiceInteraction.enumeration;
							}

							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-multiple-choice'));
							this.shadowRoot.querySelector('d2l-quiz-question-multiple-choice').setAttribute('question-data', JSON.stringify(question));
							break;

						case QuestionTypeEnum.SHORT_ANSWER:
							question.bodyText = questionData.properties.question.interaction.prompt;

							if (questionData.properties.question.modalFeedback.hint.text) {
								question.hint = questionData.properties.question.modalFeedback.hint.text;
							}

							var answers = [];
							for (const prop in questionData.properties.question.response.responseItems) {
								if (questionData.properties.question.response.responseItems.hasOwnProperty(prop)) {
									var answer = {};
									answers.push(answer);
								}
							}
							question.answers = answers;

							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-short-answer'));
							this.shadowRoot.querySelector('d2l-quiz-question-short-answer').setAttribute('question-data', JSON.stringify(question));
							break;

						default:
							this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
							break;
					}
				}
				catch (error) {
					this.shadowRoot.appendChild(document.createElement('d2l-quiz-question-not-supported'));
				}
			}

			_getQuestionData() {
				if (this.href) {
					this._fetchEntity(this.href)
						.then((questionData) => {this._appendQuestionType(questionData);}, () => {this._appendQuestionType();});
				}
			}
		}

		customElements.define(D2LQuestion.is, D2LQuestion);
	</script>
</dom-module>
