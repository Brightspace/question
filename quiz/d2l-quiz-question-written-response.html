<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="./d2l-quiz-question-hint.html">
<link rel="import" href="../../d2l-icons/d2l-icon.html">
<link rel="import" href="../../d2l-icons/tier1-icons.html">

<!--
'd2l-quiz-question-written-response'

-->

<dom-module id="d2l-quiz-question-written-response">
	<template>
		<style>
			:host {
				display: block;
			}

			#d2l-quiz-question {
				max-width: var(--d2l-quiz-question-written-response-max-width, 400px);
				width: var(--d2l-quiz-question-written-response-max-width, 400px);
			}

			#d2l-quiz-question-body {
				margin-bottom: 1rem;
			}			

			#editor-container {
				display: inline-block;
			}

			#d2l-quiz-question-hint {
				margin: 1rem 0 0 0;
			}
		
			.spell-check {
				display: inline-block;
				margin-left: 0.5rem;
			}

			#html-editor {
				border: 0px;				
			}

			.text-area {
				border-radius: 0.3rem;
				border-style: solid;
				box-sizing: border-box;
				display: inline-block;
				height: auto;
				margin: 0;
				vertical-align: middle;
				transition-duration: 0.5s;
				transition-timing-function: ease;
				transition-property: background-color, border-color;
				color: #565a5c;
				font-family: inherit;
				font-size: 0.8rem;
				font-weight: 400;
				letter-spacing: 0.02rem;
				line-height: normal;
				overflow: auto;
			}

			.text-area:hover, .text-area:focus {
				border-color: #006fbf;
				border-width: 2px;
				outline-width: 0;
			}
		</style>

		<div id="d2l-quiz-question">
			<div id="d2l-quiz-question-body" inner-h-t-m-l="[[questionData.bodyText]]" tabindex="0"></div>		
			<div id="editor-container"></div>
			<template is="dom-if" if="[[__isTextEditor(configData.htmlEditorUrl)]]">
				<d2l-icon class="spell-check" icon="d2l-tier1:spellcheck"></d2l-icon>
			</template>
			<template is="dom-if" if="[[questionData.hint]]">
				<d2l-quiz-question-hint hint="[[questionData.hint]]"></d2l-quiz-question-hint>
			</template>
		</div>
	</template>

	<script>
		class D2LQuizQuestionWrittenResponse extends Polymer.Element {
			static get is() {
				return "d2l-quiz-question-written-response";
			}

			static get properties() {
	      		return {
	        		questionData: {
	          			type: Object,
	          			readOnly: false,
			  			value: () => { return {'bodyText':'I am a test question', 'hint':'this is a hint', 'answer':null}}
	        		},

	        		configData: {
	        			type: Object,
	        			readOnly: false,
	        			observer: '_config'
	        			//value: () => { return {'htmlEditorUrl':null, 'editorRows':1, 'editorCols':100}}      			
	        		}
	      		}
	    	}

			constructor() {
				super();
			}
			
			_config() {
				const maxWidth = parseInt(getComputedStyle(this).getPropertyValue('--d2l-quiz-question-written-response-max-width'));
				if(this.configData.htmlEditorUrl) {
					const editorWidth = this.__getParameterByName('width', this.configData.htmlEditorUrl);				
					const actualWidth = editorWidth > maxWidth ? maxWidth : editorWidth;
					const editor = document.createElement('iframe');
					editor.setAttribute('id', 'html-editor');
					editor.setAttribute('scrolling', 'no');
					const editorContainer = this.shadowRoot.querySelector('#editor-container').appendChild(editor);
					editor.width = actualWidth + 2;
					editor.height = +this.__getParameterByName('height', this.configData.htmlEditorUrl) + +28;
					const url = this.configData.htmlEditorUrl.replace('width=' + editorWidth, 'width=' + actualWidth);
					editor.src = url;
				}
				else {
					const editorCols = this.configData.editorCols;
					const editorWidth = editorCols == 20 ? 169 : editorCols == 40 ? 309 : editorCols == 60 ? 449 : editorCols == 80 ? 589 : editorCols == 100 ? 729 : editorCols * 6.38;
					console.log(editorWidth);
					const actualWidth = editorWidth > maxWidth ? maxWidth : editorWidth;
					const editor = document.createElement('textarea');
					editor.setAttribute('id', 'text-editor');
					editor.classList.add('text-area');
					editor.setAttribute('rows', this.configData.editorRows);
					editor.style.width = (actualWidth - 30) + 'px';					
					const editorContainer = this.shadowRoot.querySelector('#editor-container').appendChild(editor);					
				}
			}

			__isTextEditor(url) {
                return url ? false : true;
            }
			
			__getParameterByName(name, url) {			    
			    name = name.replace(/[\[\]]/g, "\\$&");
			    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
			    var results = regex.exec(url);
			    if (!results) return null;
			    if (!results[2]) return '';
			    return decodeURIComponent(results[2].replace(/\+/g, " "));
			}
		}

		customElements.define(D2LQuizQuestionWrittenResponse.is, D2LQuizQuestionWrittenResponse);
	</script>
</dom-module>
